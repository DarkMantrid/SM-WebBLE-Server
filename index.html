<!DOCTYPE html>
<html>

<head>
    <title>Simplifier Manager Web tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="favicon.ico">
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta charset="UTF-8">
</head>

<body>
    <div class="header">
        <h1>Status 067442</h1>
        <div class="logo">
            <img src="sspn-logo-b.png" alt="Logo" class="logo-img">
        </div>
    </div>
    <div class="content" id="bluetoothInstructions" style="display: none;">
        <p>To use the Web Bluetooth feature, please follow these steps:</p>
        <ol>
            <li>Open Firefox on your Android device.</li>
            <li>Type "about:config" in the address bar and press Enter.</li>
            <li>Accept the risk and continue.</li>
            <li>In the search bar, type "dom.bluetooth.enabled".</li>
            <li>Toggle the "dom.bluetooth.enabled" preference to true by tapping on it.</li>
        </ol>
    </div>

    <div class="content">
        <table class="card-table">
            <tr>
                <td class="card">
                    <p>
                        <button id="connectBleButton" class="connectButton"> Connect to Device</button>
                        <button id="disconnectBleButton" class="disconnectButton"> Disconnect Device</button>
                    </p>
                    <p class="gray-label">BLE state: <strong><span id="bleState"
                                style="color:#d13a30;">Disconnected</span></strong></p>
                </td>
                <td class="card info-card" style="display: none;">
                    <h2>General information</h2>
                    <p class="infoReading"><span id="infoContainer"></span></p>
                </td>
                <td class="card status-card" style="display: none;">
                    <h2>Status</h2>
                    <p class="statusReading"><span id="statusContainer"></span></p>
                    <p class="gray-label" id="timestamp"></p>
                </td>
            </tr>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
            if (isFirefox) {
                document.getElementById('bluetoothInstructions').style.display = 'block';
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // DOM Elements
            const connectButton = document.getElementById('connectBleButton');
            const disconnectButton = document.getElementById('disconnectBleButton');
            const bleStateContainer = document.getElementById('bleState');
            const timestampContainer = document.getElementById('timestamp');
            const statusContainer = document.getElementById('statusContainer');
            const infoContainer = document.getElementById('infoContainer');

            // Bluetooth Variables
            let bleServer;
            let statusCharacteristicFound;
            let intervalId;
            let retryAttempts = 0;
            let connectionFailed = false; // Flag to track connection failure
            const maxRetryAttempts = 3; // Maximum number of retry attempts
            let selectedDevice = null; // To store the selected device

            // Event Listeners
            connectButton.addEventListener('click', handleConnectButtonClick);
            disconnectButton.addEventListener('click', disconnectDevice);

            // Bluetooth Constants
            const deviceName = 'ESP32-C3';
            const bleService = '08fed9e7-90be-44b5-b02c-91393f6e8988';
            const infoCharacteristic = '1cd9876e-c711-49e3-8e32-8d000e1cb6c3';
            const statusCharacteristic = '601d23b8-72c2-4965-90d1-2d8bab04f73a';

            // Event Handlers
            function handleConnectButtonClick(event) {
                if (!bleServer) {
                    if (isWebBluetoothEnabled()) {
                        connectToDevice(selectedDevice); // Pass selected device to connectToDevice
                    }
                }
            }

            function disconnectDevice() {
                if (bleServer && bleServer.connected) {
                    if (statusCharacteristicFound) {
                        statusCharacteristicFound.stopNotifications()
                            .then(() => bleServer.disconnect())
                            .then(() => {
                                updateBleState('Device Disconnected', '#d13a30');
                                clearInterval(intervalId);
                                hideInfoCard();
                                hideStatusCard();
                                bleServer = null;
                                statusCharacteristicFound = null;
                                selectedDevice = null; // Clear selected device on disconnect
                            })
                            .catch(error => console.error('An error occurred:', error));
                    }
                } else {
                    console.error("Bluetooth is not connected.");
                    window.alert("Bluetooth is not connected.");
                }
            }

            // Bluetooth Functions
            function isWebBluetoothEnabled() {
                if (!navigator.bluetooth) {
                    console.log('Web Bluetooth API is not available in this browser!');
                    updateBleState('Web Bluetooth API is not available', '#d13a30');
                    return false;
                }
                console.log('Web Bluetooth API supported in this browser.');
                return true; // Remove connectToDevice call from here
            }

            function connectToDevice(device) { // Accept device as argument
                if (!device) { // Check if device is provided
                    console.log('Initializing Bluetooth...');
                    navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: [bleService]
                    })
                        .then(selectedDevice => {
                            console.log('Device Selected:', selectedDevice.name);
                            connectToDevice(selectedDevice); // Call connectToDevice with selected device
                        })
                        .catch(error => {
                            console.error('Failed to select device:', error);
                        });
                    return; // Exit function if device selection is pending
                }

                console.log('Connecting to selected device...');
                selectedDevice = device; // Store the selected device

                selectedDevice.addEventListener('gattservicedisconnected', onDisconnected);
                selectedDevice.gatt.connect()
                    .then(gattServer => {
                        bleServer = gattServer;
                        connectionFailed = false; // Reset connectionFailed flag
                        console.log("Connected to GATT Server");
                        updateBleState(`Connected to ${selectedDevice.name}`, '#24af37', true, selectedDevice.name); // Update device connected message
                        retryAttempts = 0; // Reset retryAttempts on successful connection
                        return bleServer.getPrimaryService(bleService);
                    })
                    .then(service => {
                        console.log("Service discovered:", service.uuid);
                        return Promise.all([
                            service.getCharacteristic(statusCharacteristic).then(characteristic => {
                                console.log("Status Characteristic discovered:", characteristic.uuid);
                                statusCharacteristicFound = characteristic;
                                characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicChange);
                                return characteristic.startNotifications();
                            }),
                            service.getCharacteristic(infoCharacteristic).then(characteristic => {
                                console.log("Info Characteristic discovered:", characteristic.uuid);
                                characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicChange);
                                return characteristic.startNotifications();
                            })
                        ]);
                    })
                    .then(() => {
                        intervalId = setInterval(updateTimestamp, 1000);
                        showInfoCard();
                        showStatusCard();
                        return statusCharacteristicFound.readValue(); // Use statusCharacteristicFound here
                    })
                    .catch(error => {
                        console.error('Error: ', error);
                        connectionFailed = true; // Set connectionFailed flag
                        if (retryAttempts < maxRetryAttempts) {
                            console.log('Retrying...');
                            retryAttempts++;
                            setTimeout(connectToDevice, 3000, selectedDevice); // Retry after 3 seconds with selected device
                        } else {
                            console.error('Maximum retry attempts reached.');
                            retryAttempts = 0;
                        }
                    });
            }

            function onDisconnected(event) {
                console.log('Device Disconnected:', event.target.device.name);
                updateBleState('Device disconnected', '#d13a30');
                clearInterval(intervalId);
                hideInfoCard();
                hideStatusCard();
                retryAttempts = 0;
                bleServer = null;
                statusCharacteristicFound = null;
                selectedDevice = null; // Clear selected device on disconnect
            }

            function handleCharacteristicChange(event) {
                if (event.target instanceof BluetoothRemoteGATTCharacteristic) {
                    const newValueReceived = new TextDecoder().decode(event.target.value);
                    const obj = JSON.parse(newValueReceived);
                    if (event.target.uuid === statusCharacteristic) {
                        statusContainer.style.whiteSpace = "pre-line";
                        statusContainer.textContent = `Connected: ${obj.connected}\nNumber of packets received: ${obj.num_packets}`;
                    } else if (event.target.uuid === infoCharacteristic) {
                        infoContainer.style.whiteSpace = "pre-line";
                        infoContainer.textContent = `ID code: ${obj.id_code}\nCPU1: ${obj.firmware_cpu1}\nCPU2: ${obj.firmware_cpu2}\nHardware version: ${obj.hardware_version}\nConfig id: ${obj.config_id}`;
                    }
                } else {
                    console.log("Unknown event type:", event);
                }
            }

            // UI Functions
            function updateBleState(message, color, connected, deviceName) {
                bleStateContainer.innerHTML = message;
                bleStateContainer.style.color = color;
                if (connected !== undefined) {
                    bleStateContainer.textContent = connected ? `Connected to ${deviceName}` : 'Disconnected';
                }
            }

            function showInfoCard() {
                const statusCard = document.querySelector('.info-card');
                if (statusCard) {
                    statusCard.style.display = 'block';
                }
            }

            function hideInfoCard() {
                const statusCard = document.querySelector('.info-card');
                if (statusCard) {
                    statusCard.style.display = 'none';
                }
            }

            function showStatusCard() {
                const statusCard = document.querySelector('.status-card');
                if (statusCard) {
                    statusCard.style.display = 'block';
                }
            }

            function hideStatusCard() {
                const statusCard = document.querySelector('.status-card');
                if (statusCard) {
                    statusCard.style.display = 'none';
                }
            }

            // Update timestamp every second
            function updateTimestamp() {
                const timestamp = getDateTime();
                timestampContainer.textContent = `Last reading: ${timestamp}`;
            }

            // Utility Functions
            function getDateTime() {
                const currentdate = new Date();
                const day = ("00" + currentdate.getDate()).slice(-2);
                const month = ("00" + (currentdate.getMonth() + 1)).slice(-2);
                const year = currentdate.getFullYear();
                const hours = ("00" + currentdate.getHours()).slice(-2);
                const minutes = ("00" + currentdate.getMinutes()).slice(-2);
                const seconds = ("00" + currentdate.getSeconds()).slice(-2);
                return `${day}/${month}/${year} at ${hours}:${minutes}:${seconds}`;
            }
        });
    </script>
</body>

</html>
